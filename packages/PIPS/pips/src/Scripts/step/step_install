#!/bin/bash
# Copyright 2007, 2008, 2009 Alain Muller, Frederique Silber-Chaussumier
#
#This file is part of STEP.
#
#The program is distributed under the terms of the GNU General Public
#License.

# Ce script filtre le code généré par PIPS pour remplecer l'inclusion de STEP.h par 'include "STEP.h"'
# - le premier argument indique le répertoir d'instalation
# - les arguments suivant indique les fichiers à filtrer

install_dir=$1
shift

mkdir -p $install_dir;

while [[ $# -gt 0 ]];
do
    exec 4< $1
    exec 5> $install_dir/step.tmp
    cut=0

    while read -u 4; do
	case $REPLY in
	    "! include \"STEP.h\"" )
		if (($cut == 0)) 
		then
		    cut=1
		else
		    echo >&5 "$REPLY"
		fi
	    ;;
	    "! end include \"STEP.h\"" )
		if (($cut == 1))
		then
		    cut=0
		else
		    echo >&5 "$REPLY"
		fi
		;;
	    "!       include \"STEP.h\"" )
		echo >&5 "      include \"STEP.h\"";
		;;
	    "! MIL-STD-1753 Fortran extension not in PIPS" )
		;;
	    "!       implicit none" )
		echo >&5 "      implicit none";
		;;
	    * )
		if (($cut == 0))
		then
		    echo >&5 "$REPLY"
		fi
	esac
    done

    exec 4<&-
    exec 5>&-

    mv $install_dir/step.tmp $install_dir/$(basename $1)
    shift
done
