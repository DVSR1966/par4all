setproperty ABORT_ON_USER_ERROR TRUE
setenv WS = average_power
delete $WS
create $WS $WS.c include/SIMD.c

module $WS

setproperty RELAX_FLOAT_COMMUTATIVITY TRUE 
source include/benchmark.tpips.h

apply UNSPLIT
shell sed -i -e "1,/Define complex number/ d" $WS.database/Src/$WS.c

close

shell cc $WS.c include/SIMD.c -o ${WS}.database/Tmp/ref
shell sed -i -e '1 i #define MOD(a,b) ((a)%(b))' -e '1 i #define MAX0(a,b) (((a)>(b))?(a):(b))' ${WS}.database/Src/$WS.c
shell sed -i -e '1 i #include "SIMD.h"' $WS.database/Src/$WS.c
shell cc -Iinclude $WS.database/Src/$WS.c include/SIMD.c -o ${WS}.database/Tmp/seq
shell sed -i -e '1 d' $WS.database/Src/$WS.c
shell if test "`./${WS}.database/Tmp/seq`" = "`./${WS}.database/Tmp/ref`" ; then echo seq-ok ; else echo seq-ko ; fi

shell ./compileC.sh $WS $WS.c ${WS}.database/Tmp/sse.c
shell cc -O0 -I. -march=native ${WS}.database/Tmp/sse.c  -o ${WS}.database/Tmp/sse
shell if test "`./${WS}.database/Tmp/sse`" = "`./${WS}.database/Tmp/ref`" ; then echo sse-ok ; else echo sse-ko ; fi

#delete $WS
