#! /bin/sh
#
# $RCSfile: hpfc_compile,v $ version $Revision$
# $Date: 1994/11/30 14:32:36 $, 
# got on %D%, %T%
#

script=`basename $0`
VERBOSE=':'
DEBUG=':'
DELETE=':'
MAKE=':'
PIPS='pips'
INSTALL="$HPFC_TOOLS/hpfc_install"
PIPSARGS='-s MUST_REGIONS -p HPFCOMPILE'

unset HPFFILE MODULE WORKSPACE

#
# not very convincing. stdin is taken as stdout and stderr...

output_tty()
{
  if tty -s
  then
    tty
  else
    echo /dev/null
  fi
}

STDOUT=`output_tty`
STDERR="$STDOUT"

#
# source ~/.hpfcrc if exists. May be used to modify the defaults

[ -r "$HOME/.hpfcrc" ] && . $HOME/.hpfcrc

#

usage()
{
  cat <<-EOF
	Usage: $script [-vDdhMqs] [ -w ws ] [ -m mod ] [-n n | file[.f]]
	  version is $Revision$
	  -v: verbose
	  -D: debug
	  -d: delete
	  -h: help
	  -M: make
	  -q: quiet (stdout redirected)
	  -s: silent (stderr redirected)
	  -w ws: workspace ws
	  -m mod: module mod
	  -n n: source number n
	  file: source file
	EOF
  exit ${1:-1}
}

verbose()
{
  echo "$script: $@"
}

debug()
{
  echo "$script: $@" 1>&2
}

while getopts vDdMqsn:hm:w: OPT
do
  case $OPT in
    v) VERBOSE='verbose' ;;
    D) DEBUG='debug' ; 
       STDOUT=`output_tty` ; 
       STDERR="$STDOUT" ;;
    d) DELETE='Delete' ;;
    M) MAKE='gmake' ;;
    q) STDOUT='/dev/null' ;;
    s) STDERR='/dev/null' ;;
    n) HPFFILE="$HPFC_DIR/Tests/hpftest$OPTARG.f" ;;
    m) MODULE="$OPTARG" ;;
    w) WORKSPACE="$OPTARG" ;;
    h|*) usage 1 ;;
  esac
done

shift `expr $OPTIND - 1`

[ "$#" -eq 1 ] && { HPFFILE=`dirname $1`/`basename $1 .f`.f ; shift; }
[ "$#" -eq 0 ] || usage 2

[ "$MODULE" ] || MODULE=`basename $HPFFILE .f | tr 'a-z' 'A-Z'`
[ "$WORKSPACE" ] || WORKSPACE=`basename $HPFFILE .f`

$VERBOSE "applying hpfc on file $HPFFILE"
$DEBUG "pips is `type $PIPS`"

set -e
$PIPS -f $HPFFILE $PIPSARGS -m $MODULE $WORKSPACE > $STDOUT 2> $STDERR
set +e

$VERBOSE "installing generated codes"

[ -d "$WORKSPACE.hpfc" ] || mkdir $WORKSPACE.hpfc
${INSTALL} -b $WORKSPACE.database -r $HPFFILE -i -t $WORKSPACE.hpfc -n $MODULE

[ "$DELETE" = : ] ||
{
  $VERBOSE "deleting $WORKSPACE workspace"
  $DELETE $WORKSPACE
}

[ "$MAKE" = : ] ||
{
  $VERBOSE "making $WORKSPACE"
  (cd $WORKSPACE.hpfc ; $MAKE all) > $STDOUT 2> $STDERR
}

$VERBOSE "done"

#
# that is all
#
