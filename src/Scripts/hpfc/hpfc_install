#! /bin/sh
#
# Installation in directory...
#
# $RCSfile: hpfc_install,v $ ($Date: 1996/09/07 14:53:36 $, )
# version $Revision$
#

# defaults

unset tdir srcdir basedir reffiles toinstall tomake unsplit

verb=':'
debug=':'
srcdir=${HPFC_RUNTIME:-$PIPS_ROOT/Runtime/hpfc}
MAKE=${HPFC_MAKE:-${PIPS_MAKE:-gmake}}
M4=${HPFC_M4:-m4}

verbose()
{ echo "[$RCSfile: hpfc_install,v $]:" "$@" >&2;}

#

if [ -f "${PIPS_CURRENT_PROGRAM:-.pipsprogram}" ] 
then
  basedir="$PWD/`sed -n 's,^PGM=\(.*\)\$,\1,p' .pipsprogram`.database"
fi

# get options

usage()
{
  cat <<-EOF
	Usage: $RCSfile: hpfc_install,v $ [options]
	   version $Revision$
	   -h: help
	   -i: install
	   -m: make
	   -v: verbose
	   -d: debug
	   -q: quiet
	   -o: regenerate an origin file
	   -n name: target name
	   -t dir: target directory (default hpfc)
	   -b dir: database (default current database)
	   -s dir: where other sources are (default HPFC_INCLUDE then EXTEDIR)
	   -f file: reference file (default none)
	EOF
  exit ${1:-1}
}

while getopts himvdqot:s:b:f:n: OPT
do
  case $OPT in
    h) usage 0 ;;
    i) toinstall=1 ;;
    m) tomake=1 ;;
    v) verb='verbose' ;;
    d) debug='verbose' ;;
    q) verb=':' ;;
    o) unsplit=':' ;;
    t) tdir="$OPTARG" ;;
    s) srcdir="$OPTARG" ;;
    b) basedir="$OPTARG" ;;
    f) reffiles="$reffiles $OPTARG" ;;
    n) name="$OPTARG" ;;
    *) usage
  esac
done

$debug "args:" "$@"
shift `expr $OPTIND - 1`

#
$debug checking

[ "$#" -eq 0 ] || usage
[ "$basedir" ] || usage

name=`echo ${name:-\`basename $basedir .database\`} | tr 'A-Z' 'a-z'`

[ "$tdir" ] ||
{
  tdir=$basedir/hpfc
  [ ! -d "$tdir" ] && mkdir $tdir
}

#
$debug installating

if [ "$toinstall" ]
then
  $verb "installing in $tdir"

  $verb "cleaning $tdir"
  rm -f $tdir/*
  
  # if there is no common...
  touch $basedir/_host.h $basedir/_node.h

  $verb "copying files in $tdir"

  {
    echo "TARGET = $name" 
    cat $srcdir/hpfc_Makefile_init 
  } > $tdir/Makefile

  cp $srcdir/hpfc_check.f \
     $srcdir/hpfc_*.h \
     $srcdir/hpfc_main*.f \
     $srcdir/hpfc_architecture_m4_macros \
     $basedir/*_host.f \
     $basedir/*_host.h \
     $basedir/*_node.f \
     $basedir/*_node.h \
     $basedir/*_parameters.h \
     $basedir/*_init.h \
     $tdir

  [ "$unsplit" ] && set $basedir/[a-z]*.f 
  [ "$reffiles" ] && set `echo "$reffiles" | cut -d " " -f 2`

  $debug rebuilding initial source file
  for f 
  do
     $debug "considering $f"
     [ "`grep '^[!cC\*][Ff][Cc][Dd]\$[ 	]*[Ff][Aa][Kk][Ee][ 	]*$' $f`" ] ||
	cat $f
  done > $tdir/$name.f

  chmod ug+w $tdir/*
fi

#
$debug making

if [ "$tomake" ] 
then
  $verb "making"
  cd $tdir
  $MAKE Makefile
  $MAKE all
fi

#
# that is all
#
