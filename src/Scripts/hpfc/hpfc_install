#! /bin/sh
#
# Installation in directory...
#
# $RCSfile: hpfc_install,v $ ($Date: 1994/09/03 17:17:00 $, )
# version $Revision$
# got on %D%, %T%
# $Id$
#

# defaults

SCRIPT=`basename $0`

unset DIRECTORY SRCDIR BASEDIR REFFILE TOINSTALL TOMAKE

VERBOSE=':'
DEBUG=':'
SRCDIR=${HPFC_INCLUDE:-$EXTEDIR}
MAKE='gmake'

#

if [ -f "${PIPS_CURRENT_PROGRAM:-.pipsprogram}" ] 
then
  BASEDIR="$PWD/`sed -n 's,^PGM=\(.*\)\$,\1,p' .pipsprogram`.database"
fi

# get options

usage()
{
  cat <<-EOF
	Usage: $SCRIPT [options]
	   version $Revision$
	   -h: help
	   -i: install
	   -m: make
	   -v: verbose
	   -d: debug
	   -q: quiet
	   -t dir: target directory
	   -b dir: database (default current database)
	   -s dir: where other sources are (default HPFC_INCLUDE then EXTEDIR)
	   -r file: reference file (default none)
	EOF
  exit ${1:-1}
}

while getopts himvdqt:s:b:r: OPT
do
  case $OPT in
    h) usage 0 ;;
    i) TOINSTALL=1 ;;
    m) TOMAKE=1 ;;
    v) VERBOSE='echo' ;;
    d) DEBUG='echo' ;;
    q) VERBOSE=':' ;;
    t) DIRECTORY="$OPTARG" ;;
    s) SRCDIR="$OPTARG" ;;
    b) BASEDIR="$OPTARG" ;;
    r) REFFILE="$OPTARG" ;;
    *) usage
  esac
done

shift `expr $OPTIND - 1`

#
$DEBUG checking

[ $# -eq 0 ] || usage
[ "$BASEDIR" ] || usage

[ "$DIRECTORY" ] ||
{
  DIRECTORY=$BASEDIR/hpfc
  [ ! -d "$DIRECTORY" ] && mkdir $DIRECTORY
}

#
$DEBUG installation

if [ "$TOINSTALL" ]
then
  $VERBOSE "installing in $DIRECTORY"

  $VERBOSE "cleaning $DIRECTORY"
  rm -f $DIRECTORY/*
  
  touch $BASEDIR/_host.h $BASEDIR/_node.h

  $VERBOSE "copying files in $DIRECTORY"
  cp $SRCDIR/hpfc_*.h \
     $SRCDIR/hpfc_*.f \
     $BASEDIR/param_init.f \
     $BASEDIR/*_host.f \
     $BASEDIR/*_host.h \
     $BASEDIR/*_node.f \
     $BASEDIR/*_node.h \
     $BASEDIR/*_parameters.h \
     $BASEDIR/*_init.h \
     $PVM_ROOT/include/*pvm3.h \
     $DIRECTORY

  if [ "$REFFILE" ]
  then
    cp $REFFILE $DIRECTORY
    echo "REFFILE = ${REFFILE}" |
       cat - $SRCDIR/hpfc_Makefile > $DIRECTORY/hpfc_Makefile
  else
    cp $SRCDIR/hpfc_Makefile $DIRECTORY
  fi

  (cd $DIRECTORY; ln -s hpfc_Makefile Makefile;)

  chmod ug+w $DIRECTORY/*
fi

#
$DEBUG make

if [ "$TOMAKE" ] 
then
  $VERBOSE "making"
  cd $DIRECTORY
  $MAKE -f ./hpfc_Makefile all
fi

#
# that is all
#
