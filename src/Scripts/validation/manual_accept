#! /bin/bash
#
# $Id$
#
# accept validation files differences...

svn=
shopt -s nullglob
shopt -s extglob

# what is the current arch?
arch=${PIPS_ARCH:-$($PIPS_ROOT/makes/arch.sh)}

function handle_out_file()
{
    local outfile=$1
    shift
    local ref=${outfile%\/out}/test
    [ -f $ref.$arch ] && ref=$ref.$arch

    # show differences
    if [ -f $file ] ; then
	echo "CONSIDERING $ref and $outfile"
	if [[ ! $PIPS_GRAPHICAL_DIFF ]] ; then
            diff -b -u $ref $outfile | ${PIPS_MORE:-less}
	else
	    # Useless to use PIPS_MORE since for higher level graphical
	    # tools for example
	    ${PIPS_GRAPHICAL_DIFF} $ref $outfile
	fi
    else
	echo "NEW OUTPUT $outfile"
	${PIPS_MORE:-less} $outfile
    fi

    # ask...
    echo -e "accept (y|n)? \a"
    read answer
    if [[ $answer == [yY]* ]] ; then
	mv $outfile $ref
	[[ -d '.svn' ]] && svn=1
    else
	echo "$outfile not accepted"
    fi
}

function handle_directory()
{
    local dir=$1 outfile
    shift
    for outfile in $dir/*.result/out ; do
	handle_out_file $outfile
    done
}

if [[ ! $@ ]] ; then
    # If no directory names given, ask for accepting all the validation
    set *
fi

for arg ; do
  if [[ -d $arg ]] ; then
      handle_directory $arg
  elif [[ -f $arg ]] ; then
      outfile=${arg%.@([Ffc]|tpips)}.result/out
      if [[ -f $outfile ]] ; then
	  handle_out_file $outfile
      else
	  echo "$arg skipped, no '$outfile' out file"
      fi
  else
      echo "$arg skipped, no such file"
  fi
done

[[ $svn ]] && echo "Consider running \"svn ci $@\" to commit changes"

exit 0
