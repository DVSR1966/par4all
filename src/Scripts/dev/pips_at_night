#! /bin/bash
#
# $Id$
#
# (c) Fabien COELHO July 1996-2007
# 
# what to do at night...
#

function err()
{
    local msg=$1 code=${2:-1}
    echo -e "$0 ...\n"
    echo $msg >&2
    exit $code
}

# what to do
download=
update=
compile=
validate=

# where to do it by default
target=~/PIPS

setup='http://svn.cri.ensmp.fr/svn/nlpmake/trunk/makes/setup_pips.sh'

while [ "$1" ] 
do
  opt=$1
  case $opt in
      --) shift ; break ;;
      -*) shift ;;
      *) break ;;
  esac
  
  case $opt in
      -t|--target) target=$1 ; shift ;;
      -V|--vopt) vopt=$1 ; shift ;;
      # what to do
      -d|--download) download=1 ;;
      -nd|--no-download) download= ;;
      -u|--update) update=1 ;;
      -nu|--no-update) update= ;;
      -c|--compile) compile=1 ;;
      -nc|--no-compile) compile= ;;
      -v|--validate) validate=1 ;;
      -nv|--no-validate) validate= ;;
      # help
      -h|--help) err 'display help message' 0 ;;
      *) err "unexpected option '$opt'" 1 ;;
  esac
done

# force dowload if target does not exist
test -d $target || download=1

if [[ $download ]]
then
    test -d $target && err "will not overwrite target directory: $target" 4
    # full download
    wget --non-verbose $setup
    # should be silent?
    sh ./setup_pips.sh $target 
elif [[ $update ]]
then
    test -d $target || err "no target directory: $target" 2
    pushd $target
    svn update prod valid
    popd
else
    echo '### no download, no update'
fi

# use this PIPS
test -d $target || err "no target directory: $target" 3
source $target/pipsrc.sh

if [[ $compile && ! $download ]] 
then
    pushd $target
    # build? verbosity? clean+recompile?
    # skip documentation?
    cd prod/newgen ; make clean recompile
    cd ../linear ; make clean recompile
    cd ../pips ; make clean recompile
    popd
else
    echo '### no compile'
fi

if [[ $validate ]]
then
    pushd $target/valid
    make clean
    echo "vopt=$vopt"
    make $vopt validate
    popd
else
    echo '### no validate'
fi
