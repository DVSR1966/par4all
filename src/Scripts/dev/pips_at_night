#! /bin/bash
#
# $Id$
#
# (c) Fabien COELHO July 1996-2007
# 
# what to do at night...
#

function err()
{
    local msg=$1 code=${2:-1}
    echo -e "$0 ...\n"
    echo $msg >&2
    exit $code
}

# what to do
download=
update=
compile=
validate=

# where to do it
target=~/PIPS

setup='http://svn.cri.ensmp.fr/svn/nlpmake/trunk/makes/setup_pips.sh'

for opt in "$@" ; do
    case $opt in
	--) shift ; break ;;
	-*) shift ;;
	*) break ;;
    esac

    case $opt in
	-t|--target) target=$1 ; shift ;;
	-V|--vopt) validate_option=$1 ; shift ;;
	-d|--download) download=1 ;;
        -u|--update) update=1 ;;
	-c|--compile) compile=1 ;;
	-v|--validate) validate=1 ;;
	-h|--help) err 'display help message' 0 ;;
	*) err "unexpected option '$opt'" 1 ;;
    esac
done

# force dowload if target does not exist
test -d $target || download=1

if [[ $download ]]
then
    test -d $target && err "will not overwrite target directory: $target" 4
    # full download
    wget $setup
    # should be silent?
    sh ./setup_pips.sh $target 
elif [[ $update ]]
then
    test -d $target || err "no target directory: $target" 2
    pushd $target
    svn update prod valid
    popd
else
    echo '### no download, no update'
fi

# use this PIPS
test -d $target || err "no target directory: $target" 3
source $target/pipsrc.sh

if [[ $compile && ! $download ]] 
then
    pushd $target
    # build? verbosity? clean+recompile?
    # skip documentation?
    cd prod/newgen ; make recompile
    cd ../linear ; make recompile
    cd ../pips ; make recompile
    popd
else
    echo '### no compile'
fi

if [[ $validate ]]
then
    pushd $target/valid
    make clean
    make $validate_option validate
    popd
else
    echo '### no validate'
fi
