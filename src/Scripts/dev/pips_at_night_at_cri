#! /usr/local/bin/bash
#
# $Id$
#
# what to do at night from the pips account at cri on chailly.
#

script=/projects/Pips/Production/Utils/pips_at_night
mailto=pips_validation
remote=rsh
verb=:
more=

#
# FUNCTIONS

function usage()
{
    echo "pips_at_night_at_cri [-gvn] [-a user]";
    exit ${1:-1}
}

function verb()
{
    echo "[pips_at_night_at_cri]" "$@" `date`;
}

#
# OPTIONS

while getopts a:gvn opt
do
    case ${opt} in
        a) mailto=${OPTARG} ;;
	g) script=echo ;;
	v) verb=verb ;;
	n) more=CNLPV ;;
	*) usage 1;;
    esac
done

# what host dir archs
function doit()
{
    local what=$1 host=$2 dir=$3 archs=$4

    $verb "[doit $#] ${script} ${mailto}" \""$@"\"

    if [ $(hostname) = ${host} ]
    then 
	${script} -${what}${more}va ${mailto} -d ${dir} -c \""${archs}"\"
    else
	${PIPS_PING:-ping} ${host} && ${remote} ${host} \
	    ${script} -${what}${more}va ${mailto} -d ${dir} -c \""${archs}"\"
    fi
}

# COMPILE host dir archs
function compile()
{
    ${verb} "[compile] $@"
    doit GV "$@" ;
}

# VALIDATE host dir archs
function validate()
{
    ${verb} "[validate] $@"
    doit GCNLP "$@" ;
}

# CLEAN host dir archs
function clean()
{
    ${verb} "[clean] $@"
    doit CNLPV "$@" ;
}

#
# DO IT!

#
# general cleaning (core, database and so)

clean    chailly 	/projects/Pips . ;

#
# compilation/validation pipeline

compile  chailly 	/projects/Pips . ;
validate chailly 	/projects/Pips . &

compile  recanati 	/projects/Pips/Experiments2 GNUSOL2LL ;
validate recanati 	/projects/Pips/Experiments2 GNUSOL2LL &

compile  coulommiers 	/tmp LINUXI86 ;
validate coulommiers 	/tmp LINUXI86 &

#
# remaining compilations

compile  recanati 	/projects/Pips/Experiments2 SOL2LL ;
compile  chailly 	/projects/Pips "GNU SUN4 GPROF" ;

${verb} waiting

wait

${verb} done

# DONE
#
