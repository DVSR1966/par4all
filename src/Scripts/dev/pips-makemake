#! /bin/sh
#! /bin/sh -vx
#
# $RCSfile: pips-makemake,v $ ($Date: 1995/08/04 14:46:11 $, )
# version $Revision$

# Automatic generation of Makefile for the PIPS project
#
# Options:
#  -l: makes makefile(s) for *library(ies)*
#  -p: makes makefile(s) for *pass(es)*
#  -D: makes makefile(s) for *development*
#  -P: makes makefile(s) for *production*
#  -c: makes a makefile in *current* directory
#  -a: makes one makefile in *all* possible directories according to other 
#      options (ie. with options -lDa: all libraries in development)
#
# Remi Triolet, Bruno Baron
# Fabien Coelho, 08/95
#

usage()
{
  echo "usage: `basename $0` -l|p|s|r [-D|P] [-c|a] (default -D -c)" >&2
  [ "$2" ] && echo "error: $2" >&2
  exit ${1:-1}
}

MAKEFILE=Makefile
CONFIG_FILE=config.makefile

PIPSMAKEMAKE_OPTION=''
DIRSIDE="$DEVEDIR"
DIRTYPE=''
DIRS='.'

while getopts lpsrDPca opt
do
  case $opt in
    l)	DIRTYPE='Lib' ; PIPSMAKEMAKE_OPTION='-l';;
    p)	DIRTYPE='Passes' ; PIPSMAKEMAKE_OPTION='-p';;
    s)  DIRTYPE='Scripts' ; PIPSMAKEMAKE_OPTION='-s';;
    r)  DIRTYPE='Runtime' ; PIPSMAKEMAKE_OPTION='-r';;
    D)	DIRSIDE="$DEVEDIR" ;;
    P)	DIRSIDE="$PRODDIR/Src" ;;
    c)	DIRS='.';;
    a)	DIRS=${DIRSIDE}/${DIRTYPE}/* ;;
    *)	usage 2 "invalid option ($opt)" ;;
  esac
done
shift `expr $OPTIND - 1`

[ $# -eq 0 ] || usage 3 "$# remaining parameters"
[ "$DIRTYPE" ] || usage 4 "must specify -l|p|s|r"

### main loop
for dir in $DIRS
do
  ( cd $dir
  
  [ -f $CONFIG_FILE ] || usage 5 "no $CONFIG_FILE in $dir" ;

  # needed because of f.. - in directory names...
  dir_real_name=`basename \`pwd\``
  dir_simple_name=`echo $dir_real_name | tr '-' '_'`
    
  echo making $DIRTYPE $MAKEFILE in $dir_real_name

  [ -f $MAKEFILE ] && 
  {
    rm -f $MAKEFILE.old ;
    mv $MAKEFILE $MAKEFILE.old;
  }
    
  cat >> $MAKEFILE <<%
#	---------------------------------------------------------------
#	---------------------------------------------------------------
#
#				    Warning
#
#		  This makefile has been automatically generated
#
#			       Do not modify it
#
#        You can modify the file $CONFIG_FILE in the same directory
#
#	---------------------------------------------------------------
#	---------------------------------------------------------------
#
# Copyright (C) Ecole des Mines De Paris
#               Centre d'Automatique et Informatique
#               Section Informatique
#
# This file is part of PIPS
#
# PIPS is distributed in the hope that it will be useful, but WITHOUT ANY
# WARRANTY.  No author or distributor accepts responsibility to anyone for
# the consequences of using it or for whether it serves any particular
# purpose or works at all, unless he says so in writing.
#
# DEFAULTS, may be overwritten by the $CONFIG_FILE content.
#
TARGET=		$dir_real_name
TARGETDIR=	$(SRCDIR)/$DIRTYPE/$(TARGET)
# (obsolete?)
MAIN=		main
#
AR=             $(PIPS_AR)
ARFLAGS=        $(PIPS_ARFLAGS)
CC=             $(PIPS_CC)
CFLAGS=         $(PIPS_CFLAGS)
CPPFLAGS=       $(PIPS_CPPFLAGS)
LD=             $(PIPS_LD)
LDFLAGS=        $(PIPS_LDFLAGS)
LEX=            $(PIPS_LEX)
LFLAGS=         $(PIPS_LFLAGS)
LINT=           $(PIPS_LINT)
LINTFLAGS=      $(PIPS_LINTFLAGS)
YACC=           $(PIPS_YACC)
YFLAGS=         $(PIPS_YFLAGS)
TAR=		gtar
ZIP=		gzip -v9
# 
#
CONFIG_FILE=	$CONFIG_FILE
MAKEFILE=	$MAKEFILE
#
# to override sun's default rule
.SCCS_GET:

#
# begin of $CONFIG_FILE inclusion
#
%

cat >> $MAKEFILE $CONFIG_FILE <<%
#
# end of $CONFIG_FILE inclusion
#
%

[ $DIRTYPE = 'Lib' -o $DIRTYPE = 'Passes' ] && cat >> $MAKEFILE <<% 
#
PREPROC=	$(CC) -E $(CPPFLAGS) $(TARGET_ARCH)
COMPILE=	$(CC) $(CFLAGS) $(CPPFLAGS) $(TARGET_ARCH) -c
LINK=		$(LD) $(LDFLAGS) -o
SCAN=		$(LEX) $(LFLAGS) -t
TYPECHECK=      $(LINT) $(LINTFLAGS) $(CPPFLAGS) $(TARGET_ARCH) $(LINT_LIBS)
PARSE=		$(YACC) $(YFLAGS)
ARCHIVE=	$(AR) $(ARFLAGS)
PROTOIZE=	$(PIPS_PROTOIZE) -e -E "$(PREPROC)"
#
LIB_TARGET=	lib$(TARGET).a
BIN_TARGET=	$(TARGET)
INC_TARGET=	$(TARGET).h
#

.INIT: $MAKEFILE 
	@if test -n "$(PIPS_CHECK_OS)"; \\
	then echo "Cannot run make under this OS release"; \\
	     echo "$(PIPS_CHECK_OS)"; exit 1; \\
	fi

%

[ $DIRTYPE = 'Scripts' ] && cat >> $MAKEFILE <<%

SOURCES=	$(SCRIPTS) $(FILES) $(SFILES) $(CONFIG_FILE)
RUNS=		$(SCRIPTS) $(FILES) $(RFILES)

.runable: $(SCRIPTS)
	[ "$(SCRIPTS)" ] && chmod a+x $(SCRIPTS)
	touch .runable

check_install:
	@echo ok

.quick-install: .runable $(RFILES)
	( cd $(UTILDIR) ; $(RM) $(RUNS) )
	cp $(RUNS) $(UTILDIR)
	touch .quick-install

.INIT: $(MAKEFILE)

%

[ $DIRTYPE = 'Lib' ] && cat >> $MAKEFILE <<% 
#
CFILES=		$(MAIN).c $(LIB_CFILES)
OBJECTS=	$(MAIN).o $(LIB_OBJECTS)
INCLUDES=	$(LIB_HEADERS)
SOURCES= 	$(CONFIG_FILE) $(INCLUDES) $(CFILES)
#
# TARGETDIR=	$(LIBSRCDIR)/$(TARGET)
#
all: $(LIB_TARGET)

test: all $(DEVEDIR)/Passes/pips/pips.o
	$(LINK) pips $(DEVEDIR)/Passes/pips/pips.o $(PIPS_LIBS)
	@echo 

WPIPS_DEVEDIR=$(DEVEDIR)/Passes/wpips
# Extrait ici le noms des .o et des bibliothèques necessaires à wpips. 
# C'est très crado :-) ! RK.
# Probablement que ce serait mieux de faire un make -n dans wpips pour
# avoir l'instruction exacate à utiliser...
wtest: all $(WPIPS_DEVEDIR)/wpips.o
	$(LINK) wpips -L$(WPIPS_DEVEDIR) -L$(OPENWINHOME)/lib \\
	\`perl -ne 'chop; if (\$\$trouve != 1) \\
		{ /TARGET_OBJECTS/ && do {\$\$trouve = 1; print;}} \\
		else { s/\x5c// && print || print && exit(0);};' \\
		$(WPIPS_DEVEDIR)/config.makefile \\
	| perl -ne 's/.*=//; s/[\\t\\r\\n \x5c]+/ /g; \\
		s,([^ ]+),$(WPIPS_DEVEDIR)/\$\$1,g; print' \` \\
	\`grep '^TARGET_LIB' $(WPIPS_DEVEDIR)/config.makefile \\
		| sed -e 's/.*=/echo /' -e 's/[()]//g' | sh \`
	@echo 

$(LIB_TARGET): $(LIB_OBJECTS)
	$(RM) $(LIB_TARGET)
	$(ARCHIVE) $(LIB_TARGET) \`lorder $(LIB_OBJECTS) | tsort\`
	ranlib $(LIB_TARGET)

$(BIN_TARGET): $(LIB_TARGET) $(MAIN).o
	$(LINK) $(TARGET) $(MAIN).o $(LIB_TARGET) $(PIPS_LIBS)
	@echo 

INSTALL_TARGETS= $(INC_TARGET) $(LIB_TARGET)

check_install:
	@if test \`echo *.a | wc -w\` -gt 1 ; \\
	then \\
	  echo "install failed: additional local libraries prevent it" >&2;\\
	  exit 1;\\
	fi

# quick-install installs lib and so, so depends on these. FC
# header installed only if different.
# should avoid some recompilations if headers are not touched.
.quick-install: $(INC_TARGET) $(LIB_TARGET)
	@pips_install_file $(INC_TARGET) $(INCLUDEDIR)/$(INC_TARGET)
	@pips_install_file $(LIB_TARGET) $(LIBDIR)/$(LIB_TARGET) 
	ranlib $(LIBDIR)/$(LIB_TARGET)
	touch .quick-install

$(LIBDIR)/$(LIB_TARGET): $(LIB_TARGET) 
	cp $(LIB_TARGET) $(LIBDIR)
	ranlib $(LIBDIR)/$(LIB_TARGET)

clean:
	-$(RM) TAGS $(OBJECTS) $(INC_TARGET) $(LIB_TARGET) \\
		 $(BIN_TARGET) $(DERIVED_HEADERS) *.~[0-9]~ $(LIB_IFILES)

INC_CFILES = $(LIB_CFILES)

%

[ $DIRTYPE = 'Passes' ] && cat >> $MAKEFILE <<% 
#
CFILES=		$(TARGET_CFILES)
OBJECTS=	$(TARGET_OBJECTS)
INCLUDES=	$(TARGET_HEADERS)
SOURCES= 	$(CONFIG_FILE) $(INCLUDES) $(CFILES)
#
TARGETDIR=	$(BINSRCDIR)/$(TARGET)
#
TARGET_IFILES=	$(TARGET_CFILES:.c=.i)
#
INSTALL_TARGETS=	$(INC_TARGET) $(BIN_TARGET)

$(BIN_TARGET): $(OBJECTS) $(INC_TARGET)
	$(LINK) $(BIN_TARGET) $(OBJECTS) $(TARGET_LIBS)

check_install:
	@touch _tmp_hack.a
	@test \`echo *.a | wc -w\` -eq 1 || \\
	{ \\
	  echo "install failed: local libraries prevent it" >&2;\\
	  $(RM) _tmp_hack.a ; \\
	  exit 1;\\
	}
	@$(RM) _tmp_hack.a

.quick-install: $(INSTALL_TARGETS) $(BINDIR)
	@pips_install_file $(INC_TARGET) $(INCLUDEDIR)/$(INC_TARGET)
	@pips_install_file $(BIN_TARGET) $(BINDIR)/$(BIN_TARGET)
	touch .quick-install

clean:
	-$(RM) TAGS $(OBJECTS) $(BIN_TARGET) \\
		$(INC_TARGET) $(DERIVED_HEADERS) *.~[0-9]~

INC_CFILES = $(TARGET_CFILES)

%



###
#
# Common to all: installation and Makefile generation
#

cat >> $MAKEFILE <<%

$(TARGETDIR):
	mkdir $(TARGETDIR)

# install installs sources, so depends on sources. FC
# to insure the library is compiled before hand, a make is added.
.install: $(SOURCES) 
	$(MAKE) check_install $(INSTALL_TARGETS) $(TARGETDIR)
	@echo ""; echo; echo -n "Description of changes: " ; \\
	read comments ; \\
	install_pips_sources \\
		-v -s \`pwd\` -t $(TARGETDIR) -y "\$\$comments" \\
		$(SOURCES)
	@pips_install_file $(MAKEFILE) $(TARGETDIR)/Makefile
	touch .install
	$(MAKE) quick-install

tar:
	$(TAR) cf $(TARGET).tar $(SOURCES)
	$(ZIP) $(TARGET).tar

install:  .install
quick-install: .quick-install

$MAKEFILE: $(CONFIG_FILE) $(UTILDIR)/pips-makemake
	@pips-makemake $PIPSMAKEMAKE_OPTION

%

#
# La partie commune aux bibliotheques et aux passes :

[ $DIRTYPE = 'Lib' -o $DIRTYPE = 'Passes' ] && cat >> $MAKEFILE <<%
#
$(BINDIR)/$(BIN_TARGET): $(BIN_TARGET) $(BINDIR)
	cp $(BIN_TARGET) $(BINDIR)

$(BINDIR):
	mkdir $(BINDIR)

lint:
	$(TYPECHECK) $(CFILES) | 
		sed '/possible pointer alignment/d;/gen_alloc/d'

TAGS: $(INCLUDES) $(CFILES)
	etags $(INCLUDES) $(CFILES)
	ctage $(INCLUDES) $(CFILES)

$(TARGET)-local.h:
	[ -f $(TARGET)-local.h ] || touch $(TARGET)-local.h

# Ici commence la partie parametree en lib/passe :

# Pour eviter trop de compilations, $(INC_TARGET) ne depend pas 
#	de $(TARGET_CFILES) tout le temps :
# Work around the /*...*/ for protoize with stdarg.h. RK, 14/06/1995.
# protection against multiple reads. FC, 02/08/95
# header entry added to allow forcing the .h generation with make header
# without having to touch the sources.
header:
	{ \\
	echo "#ifndef ${dir_simple_name}_header_included" ;\\
	echo "#define ${dir_simple_name}_header_included" ;\\
	cat $(TARGET)-local.h ;\\
	$(PROTOIZE)  $(INC_CFILES) \\
		| sed 's|,[ 	]*/\*\.\.\.\*/|, ...|g;s,int .*__builtin_va_alist.*\([,\)]\),\1,' ;\\
	echo "#endif" ; \\
	} > $(INC_TARGET).tmp
	mv $(INC_TARGET).tmp $(INC_TARGET)

$(INC_TARGET): $(TARGET)-local.h $(PIPS_MAKE_DEPEND_CFILES)
	$(MAKE) header
	
depend: $(INC_TARGET) production-depend $(MAKEFILE)
# Relance une compilation de $(INC_TARGET) en rajoutant la dependance sur les
#	fichiers C :
	PIPS_MAKE_DEPEND_CFILES="$(INC_CFILES)" $(MAKE) $(INC_TARGET)


# Quand on cree le Makefile, il faut toujours le completer avec
#	les dependances d''include :
production-depend: $(DERIVED_HEADERS) $(EXTERN)
	{ sed -n 's/^		*\$\$//; 1,/^### DO NOT DELETE THIS LINE./p;' \\
		$(MAKEFILE) ;\\
	$(PREPROC) -M $(CFILES) ;\\
	} > $(MAKEFILE).new
	@pips_install_file $(MAKEFILE).new $(MAKEFILE)
	$(RM) $(MAKEFILE).new

### DO NOT DELETE THIS LINE. USED FOR MAKE DEPEND
%

# Supprime le mode silencieux -s :
#
[ $DIRTYPE = 'Lib' -o $DIRTYPE = 'Passes' ] &&
if [ $DIRSIDE = $DEVEDIR ]
then 
  make -f $MAKEFILE depend
else
  make -f $MAKEFILE production-depend
fi

### end good case

echo

)

### end main loop
done
