#! /bin/sh
#
# $RCSfile: make_release,v $ (version $Revision$)
# $Date: 1996/09/21 11:45:33 $, 
#
# (c) Fabien COELHO 1996

# creates a release, with sources / executables ???
# namely a compressed tar file?

unset name dirs root trgt oths edit
tar=${PIPS_TAR:-gtar}
taropt=cf
make=${PIPS_MAKE:-gmake}
verb=:

verbose()
{ echo "$RCSfile: make_release,v $: $@" >&2;}

error()
{ ret=$1; shift; verbose "$@"; exit $ret;}

usage()
{
    ret=$1; shift
    cat <<-EOF
	$RCSfile: make_release,v $ (version $Revision$): $@
	usage: $RCSfile: make_release,v $ [options] dirs...
	 -h: print this help
	 -v: verbose
	 -e: edit list
	 -r dir: Root directory -- absolute!
	 -t dir: Target directory -- idem!
	 -s dir: Source directories -- with release!
	 -d dir: Other directories -- direct!
	 dirs: direct directories relative to root -- cleaned!
	EOF
    exit $ret
}

while getopts hver:s:t:d: opt
do
    case $opt in
	h) usage 0 "some help" ;;
	v) verb=verbose ; taropt=cvf ;;
	e) edit=1 ;;
	r) root=$OPTARG ;;
	s) dirs="$dirs $OPTARG" ;;
	t) trgt=$OPTARG ;;
	d) oths="$oths $OPTARG" ;;
	*) error 2 invalid option -$opt ;;
    esac
done

shift `expr $OPTIND - 1`

$verb going to $root
cd $root || error 3 "cannot cd to $root"
test -d $trgt || mkdir $trgt || error 4 "cannot mkdir $trgt"

#
# tmp files

tmp=$trgt/$RCSfile: make_release,v $.`whoami`.$$
rm -f $tmp.*

$verb in `pwd`

{
    # Sources
    for dir in $dirs 
    do
	$verb "considering $dir (source)"
	$make --no-print-directory -C $dir \
	    FWD_MKFLAGS='--no-print-directory' FWD_ROOT="./$dir" release
	find ./$dir -name 'Makefile' -print
    done 

    # Direct 
    for dir in $oths "$@"
    do
	$verb "considering $dir (direct)"
	find ./$dir ! -type d -print
    done 

} | sed '/\/OLD/d;/\/SCCS/d;/~/d;/\.database/d;/\.out$/d;/core/d;' |
    sort -u > $tmp.list

#
# suggest editing the file now

test "$edit" &&
{
    echo "You can edit $tmp.list from $root to your convenience now!"
    echo "press return to continue"
    read x
}

#
# target 

$verb copying files in $trgt
$verb taring...

$tar $taropt $tmp.tar `cat $tmp.list`

# ls -l $tmp.tar 

$verb untaring in $trgt...
cd $trgt || error 5 "cannot cd to $trgt"
$tar xf $tmp.tar

$verb done

#
# cleaning

rm -f $tmp.*

# end of $RCSfile: make_release,v $ 
#
