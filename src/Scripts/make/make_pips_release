#! /bin/sh
#
# $RCSfile: make_pips_release,v $ (version $Revision$)
# $Date: 1996/09/02 20:24:43 $, 
#
# (c) Fabien COELHO 1996

unset pack what tz

tar=${PIPS_TAR:-gtar}
taropt=cf
zip=${PIPS_ZIP:-gzip -v9}
verb=:

verbose()
{ echo "$RCSfile: make_pips_release,v $: $@" >&2;}

error()
{ ret=$1; shift; verbose "$@"; exit $ret;}

usage()
{
    ret=$1
    shift
    cat <<-EOF
	$RCSfile: make_pips_release,v $ (version $Revision$): $@
	usage: $RCSfile: make_pips_release,v $ [options] name
	  misc:
	    -h: this help
	    -v: verbose
	    -z: tar and zip
	  release content:
	    -S: include sources (Include, Src, Utils)
	    -E arch: include executables for arch
	    -D arch: include libraries for this arch
	  software:
	    -p: Pips
	    -n: Newgen
	    -l: Linear
	    -e: Extern (other softs...)
	  name: target directory
	EOF
    exit $ret
}

what="-d Share -d Doc -d Runtime" 

while getopts hvzSE:D:pnle opt
do
    case $opt in
	h) usage 0 some help ;;
	v) verb=verbose ; what="$what -v" ; taropt=cvf ;;
	z) tz='1' ;;
	S) what="$what -s Src -d Include -d Utils" ;;
	E) what="$what -d Bin/$OPTARG" ;;
	D) what="$what -d Lib/$OPTARG" ;;
	p) pack="$pack PIPS" ;;
	n) pack="$pack NEWGEN" ;;
	l) pack="$pack LINEAR" ;;
	e) pack="$pack EXTERN" ;;
	*) usage 1 "invalid option -$opt" ;;
    esac
done

shift `expr $OPTIND - 1 `

name=${1:-$PIPS_RELEASE/default_pips_release}

test -d $name || mkdir $name || error 2 "cannot create directory $name"

#
#

for p in $pack
do
    case $p in
	PIPS) root=$PIPS_ROOT ; trg=$name/Pips ;;
	NEWGEN) root=$NEWGEN_ROOT ; trg=$name/Newgen ;;
	LINEAR) root=$LINEAR_ROOT ; trg=$name/Linear ;;
	EXTERN) root=$LINEAR_ROOT ; trg=$name/Extern ;;
    esac
    $verb "packing for $p ($root) in $trg:"
    $verb "what=$what"
    make_release -v -r $root -t $trg $what
done

test "$tz" && 
{
    $verb "taring and zipping"
    cd `dirname $name`
    base=`basename $name`
    $tar $taropt $base.tar $base
    eval $zip $base.tar
    rm -rf $base
}

# end of $RCSfile: make_pips_release,v $
#
