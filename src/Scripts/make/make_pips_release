#! /bin/sh
#
# $RCSfile: make_pips_release,v $ (version $Revision$)
# $Date: 1996/09/10 16:39:33 $, 
#
# (c) Fabien COELHO 1996

unset pack what tz zip name tostrip strip install

tar=${PIPS_TAR:-gtar}
taropt=cf
zip=${PIPS_ZIP:-"gzip -v9"}
verb=:

# having the full Doc is too much for binary releases?
what="-d Share -d Doc -d Runtime -d Examples" 

verbose()
{ echo "$RCSfile: make_pips_release,v $: $@" >&2;}

error()
{ ret=$1; shift; verbose "$@"; exit $ret;}

usage()
{
    ret=$1
    shift
    cat <<-EOF
	$RCSfile: make_pips_release,v $ (version $Revision$): $@
	usage: $RCSfile: make_pips_release,v $ [options] name
	  misc:
	    -h: this help
	    -v: verbose
	    -r: add proper installation and readme files in the root
	    -s: strip binaries
	    -z: tar and zip
	    -w: additional options for make_release [-w '-e']
	  release content:
	    default: Share Doc Runtime Examples 
	    -S: add sources (Include, Src, Utils, Validation)
	    -D dir: add directory dir
	    -B arch: add binaries for arch (Bin/arch)
	    -L arch: add libraries for arch (Lin/arch)
	  software:
	    -p: Pips
	    -n: Newgen
	    -l: Linear
	    -e: Extern (other softs...)
	  name: target (a date & content-dependent default is provided)
	EOF
    exit $ret
}

while getopts hvrszw:SB:L:D:pnle opt
do
    case $opt in
	h) usage 0 some help ;;
	v) verb=verbose ; what="$what -v" ; taropt=cvf ;;
	r) install='1' ;;
	s) strip='strip' ;;
	z) tz='1' ;;
	w) what="$what $OPTARG" ;;
	S) what="$what -s Src -d Include -d Utils -d Validation" ; 
	   name="${name}S" ;;
	B) what="$what -d Bin/$OPTARG" ;
	   name="${name}B$OPTARG" ;
	   tostrip="$tostrip Bin/$OPTARG" ;;
	L) what="$what -d Lib/$OPTARG" ; name="${name}L$OPTARG" ;;
	D) what="$what -d $OPTARG"  ; name="${name}D$OPTARG" ;;
	p) pack="$pack PIPS" ; name="${name}p" ;;
	n) pack="$pack NEWGEN" ; name="${name}n" ;;
	l) pack="$pack LINEAR" ; name="${name}l" ;;
	e) pack="$pack EXTERN" ; name="${name}e" ;;
	*) usage 1 "invalid option -$opt" ;;
    esac
done

shift `expr $OPTIND - 1 `

# default: //"%H""%M""%S"
name=${1:-${PIPS_DIR}/Release/pips_${name}_`date +"%y""%m""%d"`}
base=`basename $name`

$verb "target release name: $name"

test -d $name || mkdir $name || error 2 "cannot create directory $name"

#
# get the files

for p in $pack
do
    #
    # set the parameters
    case $p in
	PIPS)   root=$PIPS_ROOT   ; trg=$name/Pips   ;;
	NEWGEN) root=$NEWGEN_ROOT ; trg=$name/Newgen ;;
	LINEAR) root=$LINEAR_ROOT ; trg=$name/Linear ;;
	EXTERN) root=$EXTERN_ROOT ; trg=$name/Extern ;;
    esac

    #
    # copy directories
    $verb "packing for $p ($root) in $trg:"
    $verb "what=$what"
    make_release -v -r $root -t $trg $what

    #
    # strip if required
    test "$tostrip" -a "$strip" &&
    {
	$verb stripping binaries
	for d in $tostrip ; do $strip $trg/$d/* ; done
    }
done

#
# installation

test "$install" &&
{
    $verb "copying installation software and doc"
    cp ${PIPS_ROOT}/Utils/install_pips $name/install_pips
    cp ${PIPS_ROOT}/Utils/install.README $name/README
    cp ${PIPS_ROOT}/Utils/install.INSTALL $name/INSTALL
}

#
# tar and zip if required

test "$tz" && 
{
    cd `dirname $name`
    $verb "taring ($tar $taropt) and zipping ($zip)"
    $tar $taropt $base.tar $base
    $zip $base.tar
    rm -rf $base
}

# end of $RCSfile: make_pips_release,v $
#
