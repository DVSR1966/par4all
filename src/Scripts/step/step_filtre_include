#!/bin/bash
# Copyright 2007, 2008, 2009 Alain Muller, Frederique Silber-Chaussumier
#
#This file is part of STEP.
#
#The program is distributed under the terms of the GNU General Public
#License.

# Ce script filtre le code généré par PIPS pour remplacer l'include de DEFAULT_STEP_HEADER par l'include de STEP_HEADER
# - le premier argument indique le répertoir d'instalation
# - le second argument indique DEFAULT_STEP_HEADER
# - le troisième argument indique STEP_HEADER
# - les arguments suivant indique les fichiers à filtrer

INSTAL_DIR=$1
DEFAULT_STEP_HEADER=$2
STEP_HEADER=$3

shift 3

mkdir -p $INSTAL_DIR;

while [[ $# -gt 0 ]];
do
    exec 4< $1
    exec 5> $INSTAL_DIR/step.tmp
    cut=0

    while read -u 4; do
	case $REPLY in
	    "! include \"$DEFAULT_STEP_HEADER\"" )
		if (($cut == 0)) 
		then
		    cut=1
		else
		    echo >&5 "$REPLY"
		fi
	    ;;
	    "! end include \"$DEFAULT_STEP_HEADER\"" )
		if (($cut == 1))
		then
		    cut=0
		else
		    echo >&5 "$REPLY"
		fi
		;;
	    "!       include \"$DEFAULT_STEP_HEADER\"" )
		echo >&5 "      include \"$STEP_HEADER\"";
		;;
	    "! MIL-STD-1753 Fortran extension not in PIPS" )
		;;
	    "!       implicit none" )
		echo >&5 "      implicit none";
		;;
	    * )
		if (($cut == 0))
		then
		    echo >&5 "$REPLY"
		fi
	esac
    done

    exec 4<&-
    exec 5>&-

    mv $INSTAL_DIR/step.tmp $INSTAL_DIR/$(basename $1)
    shift
done
