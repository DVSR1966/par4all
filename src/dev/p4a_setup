#! /bin/bash -vx
#
# Inspired from setup_pips.sh from Fabien Coelho and get-pips4u.sh from
# Sebastien Varrette <Sebastien.Varrette@uni.lu> and Serge Guelton
# <Serge.Guelton@telecom-bretagne.eu>
#

# Stop on error, since going on after errors may lead to havoc
set -o errexit

if [[ -z $P4A_ROOT ]]; then
    echo "You need to have \$P4A_ROOT defined to the Par4All top-level directory"
    exit
fi

# Where everything is built:
P4A_BUILD=$P4A_ROOT/build
# Where things are installed
P4A_INSTALL_PREFIX=$P4A_ROOT/run

P4A_ETC=$P4A_BUILD/etc

if test -z "$INSTALL_PREFIX" ; then
    # install prefix passed by --prefix to the configure script
    INSTALL_PREFIX=$P4A_INSTALL_PREFIX
fi
mkdir -p $INSTALL_PREFIX

# default flags for the configure script
PIPS_CONFIGURE_COMMON_FLAGS=" --disable-static"

cd $P4A_ROOT

PIPS_COMPONENTS="linear newgen pips"
PIPS_DIR=$P4A_ROOT/packages/PIPS

# The config files to source later:
P4A_RC_SH=$P4A_ETC/par4all-rc.sh
P4A_RC_CSH=$P4A_ETC/par4all-rc.csh

# Build the package of name $1 that is to be found into directory $2:
function build_package() {
    local package=$1
    local dir=$2
    (
	cd $dir
	dir=`pwd`
	# There are lacking files in the Polylib that autoreconf do not
	# want to create :-(
	touch NEWS README AUTHORS ChangeLog
	autoreconf --install
	mkdir -p $P4A_BUILD/$package
	cd $P4A_BUILD/$package
	$dir/configure ${PIPS_CONFIGURE_COMMON_FLAGS}
	make
	make install
    )
}

# Add a potentially missing link to the PIPS make infrastructure for a
# given component:
function add_link_to_make_infrastructure () {
    local package=$1
    ln -s -f ../nlpmake/makes $P4A_ROOT/packages/PIPS/$package/makes
}

PIPS_CONFIGURE_COMMON_FLAGS="${PIPS_CONFIGURE_COMMON_FLAGS} --prefix=${INSTALL_PREFIX}"

build_package polylib packages/polylib

add_link_to_make_infrastructure newgen
build_package newgen packages/PIPS/newgen

PIPS_CONFIGURE_COMMON_FLAGS="${PIPS_CONFIGURE_COMMON_FLAGS} PKG_CONFIG_PATH=${INSTALL_PREFIX}/lib/pkgconfig:$PKG_CONFIG_PATH"

add_link_to_make_infrastructure linear
build_package linear packages/PIPS/linear

PIPS_CONFIGURE_COMMON_FLAGS="${PIPS_CONFIGURE_COMMON_FLAGS} ${PIPS_CONFIG} PATH=${INSTALL_PREFIX}/bin:$PATH "

add_link_to_make_infrastructure pips
build_package pips packages/PIPS/pips

# that's all folks
cat << EOF
============================================
pips4u is ready
everything got installed in $INSTALL_PREFIX
all sources are available from $SRCDIR

you should consider add the following lines
to your .bashrc or whatever:

export PATH=$INSTALL_PREFIX/bin:\$PATH
export LD_LIBRARY_PATH=$INSTALL_PREFIX/lib
export PKG_CONFIG_PATH=$INSTALL_PREFIX/lib/pkgconfig
export PYTHONPATH=$INSTALL_PREFIX/lib/python2.6/site-packages/pips

============================================
EOF

exit 0
